import React, { useState, useEffect, useRef } from 'react';
import { 
  Heart, 
  Settings, 
  Calendar, 
  Plus, 
  Image as ImageIcon, 
  Type, 
  X, 
  Sparkles, 
  Palette,
  Check,
  ChevronRight
} from 'lucide-react';

// --- Constants ---
const PRIMARY_PASSCODE = "162930";

const THEMES = {
  romantic: {
    name: 'Romantic Rose',
    bg: 'bg-rose-50',
    header: 'bg-rose-500',
    accent: 'text-rose-600',
    card: 'bg-white',
    border: 'border-rose-200'
  },
  midnight: {
    name: 'Midnight Stars',
    bg: 'bg-slate-900',
    header: 'bg-indigo-900',
    accent: 'text-indigo-400',
    card: 'bg-slate-800 text-white',
    border: 'border-indigo-500'
  },
  sunset: {
    name: 'Golden Hour',
    bg: 'bg-orange-50',
    header: 'bg-orange-400',
    accent: 'text-orange-600',
    card: 'bg-white',
    border: 'border-orange-200'
  }
};

const NOTE_TEMPLATES = [
  { id: 'torn', name: 'Torn Paper', class: 'before:content-[""] before:absolute before:top-0 before:left-0 before:right-0 before:h-4 before:bg-[url("https://www.transparenttextures.com/patterns/notebook.png")]' },
  { id: 'classic', name: 'Classic Letter', class: 'border-l-4 border-rose-300 pl-4' },
  { id: 'envelope', name: 'Inside Envelope', class: 'rounded-t-none border-t-8 border-rose-400' }
];

const PHOTO_FILTERS = [
  { name: 'None', filter: 'none' },
  { name: 'Tokyo Sunset', filter: 'sepia(0.3) saturate(1.5) hue-rotate(-10deg)' },
  { name: 'Summer Vibe', filter: 'brightness(1.1) saturate(1.2) contrast(0.9)' },
  { name: 'Vintage Love', filter: 'grayscale(0.2) contrast(1.1)' }
];

// --- Mock AI Service ---
const getAILetter = async (prompt) => {
  await new Promise(resolve => setTimeout(resolve, 1500));
  return `My Dearest,\n\nEvery moment we spend apart only makes me realize how much you mean to me. Even though miles separate us, your love is the light that guides my days. I'm counting down the seconds until we're together again.\n\nForever Yours.`;
};

const getAICaption = async () => {
  await new Promise(resolve => setTimeout(resolve, 800));
  return "Distance means so little when someone means so much. ✨";
};

// --- Main App Component ---
export default function App() {
  const [stage, setStage] = useState('security'); 
  const [passcode, setPasscode] = useState('');
  const [error, setError] = useState(false);
  const [activeTheme, setActiveTheme] = useState('romantic');
  const [frowns, setFrowns] = useState([]);
  const [items, setItems] = useState([]);
  const [reminders, setReminders] = useState([
    { id: 1, title: 'Our Anniversary', date: '2026-10-15' }
  ]);
  const [showModal, setShowModal] = useState(null); 
  const [isAiLoading, setIsAiLoading] = useState(false);
  
  const inputRef = useRef(null);

  // Focus input automatically and on click
  useEffect(() => {
    if (stage === 'security' && inputRef.current) {
      inputRef.current.focus();
    }
  }, [stage]);

  const handleSecurityClick = () => {
    if (inputRef.current) inputRef.current.focus();
  };

  const validatePasscode = (val) => {
    if (val === PRIMARY_PASSCODE) {
      setStage('welcome');
      setTimeout(() => setStage('dashboard'), 3000);
    } else {
      setError(true);
      const newFrowns = Array.from({ length: 15 }).map((_, i) => ({
        id: Date.now() + i,
        left: Math.random() * 100
      }));
      setFrowns(newFrowns);
      setTimeout(() => {
        setFrowns([]);
        setError(false);
        setPasscode('');
      }, 3000);
    }
  };

  const handlePasscodeChange = (e) => {
    const val = e.target.value.replace(/\D/g, ''); // Only digits
    if (val.length > 6) return;
    setPasscode(val);
    if (val.length === 6) {
      validatePasscode(val);
    }
  };

  const theme = THEMES[activeTheme];

  if (stage === 'security') {
    return (
      <div 
        className="h-screen w-full bg-slate-900 flex flex-col items-center justify-center text-white overflow-hidden relative cursor-pointer"
        onClick={handleSecurityClick}
      >
        {frowns.map(f => (
          <div 
            key={f.id} 
            className="absolute top-[-50px] text-4xl animate-bounce"
            style={{ left: `${f.left}%`, animationDuration: `${Math.random() * 2 + 1}s` }}
          >
            ☹️
          </div>
        ))}

        <h1 className="text-4xl font-bold mb-8 animate-pulse tracking-widest text-center px-4">
          TO OUR BELOVING WORLD
        </h1>

        <div className="flex gap-2 sm:gap-4 mb-8">
          {[...Array(6)].map((_, i) => (
            <div 
              key={i} 
              className={`w-10 h-14 sm:w-12 sm:h-16 border-2 rounded-lg flex items-center justify-center text-2xl font-mono
                ${error ? 'border-red-500 bg-red-900/20' : 'border-rose-400 bg-white/10'}`}
            >
              {passcode[i] ? '•' : ''}
            </div>
          ))}
        </div>

        <input 
          ref={inputRef}
          type="text"
          pattern="\d*"
          inputMode="numeric"
          className="opacity-0 absolute pointer-events-none" 
          value={passcode} 
          onChange={handlePasscodeChange}
          autoFocus
        />

        {error && (
          <p className="text-red-400 font-medium animate-shake text-center px-4">
            Sorry, you are not the one who can enter.
          </p>
        )}
        
        <p className="mt-10 text-slate-500 text-sm italic">
          {passcode.length < 6 ? 'Type the 6-digit key of our hearts' : 'Verifying...'}
        </p>

        {/* Mobile helper if keyboard doesn't pop up */}
        <button 
          onClick={handleSecurityClick}
          className="mt-4 text-xs bg-white/10 px-4 py-2 rounded-full text-slate-400 hover:bg-white/20 sm:hidden"
        >
          Tap to Open Keyboard
        </button>
      </div>
    );
  }

  if (stage === 'welcome') {
    return (
      <div className="h-screen w-full bg-black flex items-center justify-center overflow-hidden">
        <div className="text-center z-10">
          <h2 className="text-white text-5xl font-serif animate-bounce px-4">
            Welcome to our world
          </h2>
        </div>
        <div className="absolute inset-0 pointer-events-none">
          {[...Array(20)].map((_, i) => (
            <div 
              key={i} 
              className="absolute w-2 h-2 rounded-full animate-ping"
              style={{
                top: `${Math.random() * 100}%`,
                left: `${Math.random() * 100}%`,
                backgroundColor: ['#fb7185', '#38bdf8', '#fbbf24', '#c084fc'][i % 4],
                animationDelay: `${Math.random() * 2}s`
              }}
            />
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className={`min-h-screen transition-colors duration-500 ${theme.bg}`}>
      {/* Header */}
      <header className={`${theme.header} p-4 shadow-lg text-white sticky top-0 z-50`}>
        <div className="max-w-6xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-4">
            <div className="group relative">
              <button className="p-2 hover:bg-white/20 rounded-full transition">
                <Palette size={24} />
              </button>
              <div className="absolute top-full left-0 mt-2 bg-white text-slate-800 rounded-lg shadow-xl p-2 hidden group-hover:block border">
                {Object.entries(THEMES).map(([key, t]) => (
                  <button 
                    key={key} 
                    onClick={() => setActiveTheme(key)}
                    className="flex items-center gap-2 w-full px-3 py-2 hover:bg-slate-100 rounded text-sm"
                  >
                    <div className={`w-3 h-3 rounded-full ${t.header}`} />
                    {t.name}
                  </button>
                ))}
              </div>
            </div>
          </div>

          <h1 className="text-2xl font-bold italic tracking-wider whitespace-nowrap overflow-hidden flex-1 mx-4">
            <div className="animate-marquee inline-block px-4">
              YOU ARE MY WORLD • YOU ARE MY WORLD • YOU ARE MY WORLD
            </div>
          </h1>

          <div className="flex items-center gap-4">
             <div className="text-right hidden md:block">
                <p className="text-xs opacity-80 uppercase">Next Important Date</p>
                <p className="font-bold text-sm">
                  {reminders[0]?.title}: {reminders[0]?.date}
                </p>
             </div>
             <button 
              onClick={() => setShowModal('settings')}
              className="p-2 hover:bg-white/20 rounded-full transition"
            >
              <Calendar size={24} />
            </button>
          </div>
        </div>
      </header>

      {/* Main Board */}
      <main className="max-w-5xl mx-auto p-4 sm:p-8 relative min-h-[calc(100vh-80px)]">
        {items.length === 0 && (
          <div className="flex flex-col items-center justify-center h-64 border-2 border-dashed border-slate-300 rounded-3xl opacity-40">
            <p className="text-xl">Our board is currently blank...</p>
            <p className="text-sm">Start pinning memories below</p>
          </div>
        )}

        {/* Board Items */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-24">
          {items.map((item) => (
            <div 
              key={item.id} 
              className={`p-6 rounded-2xl shadow-md transition-all hover:scale-105 relative ${theme.card} ${theme.border} border`}
              style={item.type === 'photo' ? { borderColor: item.frameColor, borderWidth: '4px' } : {}}
            >
              <button 
                onClick={() => setItems(prev => prev.filter(i => i.id !== item.id))}
                className="absolute -top-2 -right-2 bg-white shadow rounded-full p-1 text-slate-400 hover:text-red-500 z-10"
              >
                <X size={14} />
              </button>

              {item.type === 'note' ? (
                <div className={`${item.templateClass} min-h-[150px]`}>
                  <p 
                    className="whitespace-pre-wrap"
                    style={{ 
                      fontWeight: item.bold ? 'bold' : 'normal',
                      textDecoration: item.underline ? 'underline' : 'none',
                      fontSize: `${item.fontSize}px`,
                      fontFamily: item.fontStyle
                    }}
                  >
                    {item.content}
                  </p>
                </div>
              ) : (
                <div className="flex flex-col gap-3">
                  <div 
                    className={`overflow-hidden ${item.frameShape === 'round' ? 'rounded-full aspect-square' : 'rounded-lg'}`}
                    style={{ borderColor: item.frameColor }}
                  >
                    <img 
                      src={item.imageUrl} 
                      className="w-full h-48 object-cover" 
                      style={{ filter: item.photoFilter }}
                      alt="Moment" 
                    />
                  </div>
                  <p className="text-center italic text-sm text-slate-500">{item.caption}</p>
                </div>
              )}
              <div className="mt-4 text-[10px] text-slate-400 text-right">
                Pinned on {item.timestamp}
              </div>
            </div>
          ))}
        </div>

        {/* Floating Heart Button */}
        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-40">
          <div className="relative group">
            <button className="bg-rose-500 text-white p-5 rounded-full shadow-2xl hover:scale-110 transition-transform flex items-center justify-center">
              <Heart size={32} fill="currentColor" />
            </button>
            
            <div className="absolute bottom-full mb-4 left-1/2 -translate-x-1/2 flex gap-4 scale-0 group-hover:scale-100 transition-transform origin-bottom">
              <button 
                onClick={() => setShowModal('note')}
                className="bg-white text-rose-500 p-4 rounded-2xl shadow-lg flex flex-col items-center hover:bg-rose-50 transition"
              >
                <Type size={20} />
                <span className="text-xs font-bold mt-1">Note</span>
              </button>
              <button 
                onClick={() => setShowModal('photo')}
                className="bg-white text-rose-500 p-4 rounded-2xl shadow-lg flex flex-col items-center hover:bg-rose-50 transition"
              >
                <ImageIcon size={20} />
                <span className="text-xs font-bold mt-1">Photo</span>
              </button>
            </div>
          </div>
        </div>
      </main>

      {/* Modals */}
      {showModal && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-3xl w-full max-w-2xl overflow-hidden animate-in fade-in zoom-in duration-200 shadow-2xl">
            <div className="p-6 border-b flex justify-between items-center bg-slate-50">
              <h3 className="text-xl font-bold flex items-center gap-2">
                {showModal === 'note' && <><Type size={20} /> Pin a Love Note</>}
                {showModal === 'photo' && <><ImageIcon size={20} /> Pin a Moment</>}
                {showModal === 'settings' && <><Calendar size={20} /> Important Dates</>}
              </h3>
              <button onClick={() => setShowModal(null)} className="p-1 hover:bg-slate-200 rounded-full">
                <X size={24} />
              </button>
            </div>

            <div className="p-6 max-h-[70vh] overflow-y-auto">
              {showModal === 'note' && (
                <NoteEditor 
                  onSave={(data) => { setItems([data, ...items]); setShowModal(null); }}
                  isAiLoading={isAiLoading}
                  setIsAiLoading={setIsAiLoading}
                />
              )}
              {showModal === 'photo' && (
                <PhotoEditor 
                  onSave={(data) => { setItems([data, ...items]); setShowModal(null); }}
                  isAiLoading={isAiLoading}
                  setIsAiLoading={setIsAiLoading}
                />
              )}
              {showModal === 'settings' && (
                <ReminderSettings 
                  reminders={reminders} 
                  setReminders={setReminders} 
                />
              )}
            </div>
          </div>
        </div>
      )}

      <style>{`
        @keyframes marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(-50%); }
        }
        .animate-marquee {
          animation: marquee 15s linear infinite;
        }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }
        .animate-shake {
          animation: shake 0.2s ease-in-out infinite;
        }
      `}</style>
    </div>
  );
}

// --- Sub-Components ---

function NoteEditor({ onSave, isAiLoading, setIsAiLoading }) {
  const [content, setContent] = useState('');
  const [fontStyle, setFontStyle] = useState('serif');
  const [fontSize, setFontSize] = useState(16);
  const [bold, setBold] = useState(false);
  const [underline, setUnderline] = useState(false);
  const [template, setTemplate] = useState('classic');

  const generateAI = async () => {
    setIsAiLoading(true);
    const text = await getAILetter();
    setContent(text);
    setIsAiLoading(false);
  };

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap gap-2 items-center bg-slate-100 p-2 rounded-lg">
        <select className="text-sm p-1 rounded border" value={fontStyle} onChange={e => setFontStyle(e.target.value)}>
          <option value="serif">Serif</option>
          <option value="sans-serif">Sans</option>
          <option value="cursive">Cursive</option>
          <option value="monospace">Mono</option>
        </select>
        <input type="number" className="w-12 text-sm p-1 rounded border" value={fontSize} onChange={e => setFontSize(e.target.value)} />
        <button onClick={() => setBold(!bold)} className={`p-1 rounded ${bold ? 'bg-rose-500 text-white' : 'hover:bg-slate-200'}`}><b>B</b></button>
        <button onClick={() => setUnderline(!underline)} className={`p-1 rounded ${underline ? 'bg-rose-500 text-white' : 'hover:bg-slate-200'}`}><u>U</u></button>
        <div className="h-4 w-px bg-slate-300 mx-2" />
        <button 
          onClick={generateAI} 
          disabled={isAiLoading}
          className="flex items-center gap-1 text-xs font-bold text-rose-600 animate-pulse"
        >
          <Sparkles size={14} /> {isAiLoading ? 'Writing...' : 'AI Love Letter'}
        </button>
      </div>

      <textarea 
        className="w-full h-40 p-4 border rounded-xl focus:ring-2 focus:ring-rose-300 outline-none"
        placeholder="Write your heart out..."
        value={content}
        onChange={e => setContent(e.target.value)}
        style={{ fontFamily: fontStyle, fontSize: `${fontSize}px`, fontWeight: bold ? 'bold' : 'normal', textDecoration: underline ? 'underline' : 'none' }}
      />

      <div>
        <label className="text-xs font-bold text-slate-500 block mb-2">NOTE TEMPLATE</label>
        <div className="grid grid-cols-3 gap-2">
          {NOTE_TEMPLATES.map(t => (
            <button 
              key={t.id}
              onClick={() => setTemplate(t.id)}
              className={`text-xs p-2 border rounded-lg text-center ${template === t.id ? 'border-rose-500 bg-rose-50' : 'hover:bg-slate-50'}`}
            >
              {t.name}
            </button>
          ))}
        </div>
      </div>

      <button 
        disabled={!content}
        onClick={() => onSave({
          id: Date.now(),
          type: 'note',
          content,
          fontStyle,
          fontSize,
          bold,
          underline,
          templateClass: NOTE_TEMPLATES.find(t => t.id === template)?.class || '',
          timestamp: new Date().toLocaleDateString()
        })}
        className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold hover:bg-rose-600 disabled:opacity-50"
      >
        Pin to Board
      </button>
    </div>
  );
}

function PhotoEditor({ onSave, isAiLoading, setIsAiLoading }) {
  const [imageUrl, setImageUrl] = useState('https://images.unsplash.com/photo-1518199266791-5375a83190b7?q=80&w=800&auto=format&fit=crop');
  const [caption, setCaption] = useState('');
  const [frameShape, setFrameShape] = useState('square');
  const [frameColor, setFrameColor] = useState('#fda4af');
  const [photoFilter, setPhotoFilter] = useState('none');

  const generateCaption = async () => {
    setIsAiLoading(true);
    const text = await getAICaption();
    setCaption(text);
    setIsAiLoading(false);
  };

  return (
    <div className="space-y-4">
      <div className="flex gap-4">
        <div className={`w-1/3 aspect-square bg-slate-100 rounded-lg flex items-center justify-center overflow-hidden border-4`} style={{ borderColor: frameColor, borderRadius: frameShape === 'round' ? '999px' : '8px' }}>
          <img src={imageUrl} className="w-full h-full object-cover" style={{ filter: photoFilter }} alt="Preview" />
        </div>
        <div className="flex-1 space-y-3">
          <input 
            type="text" 
            placeholder="Image URL..." 
            className="w-full p-2 text-sm border rounded"
            value={imageUrl}
            onChange={e => setImageUrl(e.target.value)}
          />
          <div className="flex gap-2">
            <button onClick={() => setFrameShape('square')} className={`flex-1 p-2 text-xs border rounded ${frameShape === 'square' ? 'bg-rose-100 border-rose-400' : ''}`}>Square</button>
            <button onClick={() => setFrameShape('round')} className={`flex-1 p-2 text-xs border rounded ${frameShape === 'round' ? 'bg-rose-100 border-rose-400' : ''}`}>Round</button>
          </div>
          <div className="flex items-center gap-2">
            <label className="text-xs font-bold text-slate-500">FRAME COLOR</label>
            <input type="color" value={frameColor} onChange={e => setFrameColor(e.target.value)} className="h-8 w-8 rounded overflow-hidden" />
          </div>
        </div>
      </div>

      <div>
        <label className="text-xs font-bold text-slate-500 block mb-2">PHOTO THEME</label>
        <div className="grid grid-cols-4 gap-2">
          {PHOTO_FILTERS.map(f => (
            <button 
              key={f.name}
              onClick={() => setPhotoFilter(f.filter)}
              className={`text-[10px] p-2 border rounded-lg text-center ${photoFilter === f.filter ? 'border-rose-500 bg-rose-50' : 'hover:bg-slate-50'}`}
            >
              {f.name}
            </button>
          ))}
        </div>
      </div>

      <div className="space-y-2">
        <div className="flex justify-between">
          <label className="text-xs font-bold text-slate-500">CAPTION</label>
          <button 
            onClick={generateCaption} 
            disabled={isAiLoading}
            className="text-[10px] font-bold text-rose-500 flex items-center gap-1"
          >
            <Sparkles size={10} /> AI Caption
          </button>
        </div>
        <input 
          type="text" 
          className="w-full p-2 border rounded-lg text-sm" 
          value={caption}
          onChange={e => setCaption(e.target.value)}
          placeholder="A sweet memory..."
        />
      </div>

      <button 
        onClick={() => onSave({
          id: Date.now(),
          type: 'photo',
          imageUrl,
          caption,
          frameShape,
          frameColor,
          photoFilter,
          timestamp: new Date().toLocaleDateString()
        })}
        className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold hover:bg-rose-600"
      >
        Pin Photo
      </button>
    </div>
  );
}

function ReminderSettings({ reminders, setReminders }) {
  const [newDate, setNewDate] = useState('');
  const [newTitle, setNewTitle] = useState('');

  const addDate = () => {
    if (!newDate || !newTitle) return;
    setReminders([{ id: Date.now(), title: newTitle, date: newDate }, ...reminders]);
    setNewTitle('');
    setNewDate('');
  };

  return (
    <div className="space-y-6">
      <div className="bg-slate-50 p-4 rounded-2xl border">
        <h4 className="text-sm font-bold text-slate-700 mb-3">Add New Moment</h4>
        <div className="flex flex-col gap-2">
          <input 
            type="text" 
            placeholder="Event Name (e.g., First Trip)" 
            className="p-2 border rounded-lg text-sm"
            value={newTitle}
            onChange={e => setNewTitle(e.target.value)}
          />
          <div className="flex gap-2">
            <input 
              type="date" 
              className="flex-1 p-2 border rounded-lg text-sm"
              value={newDate}
              onChange={e => setNewDate(e.target.value)}
            />
            <button 
              onClick={addDate}
              className="bg-rose-500 text-white px-4 rounded-lg hover:bg-rose-600 transition"
            >
              <Plus size={20} />
            </button>
          </div>
        </div>
      </div>

      <div className="space-y-2">
        <h4 className="text-sm font-bold text-slate-500 uppercase tracking-wider">Upcoming Dates</h4>
        {reminders.map(r => (
          <div key={r.id} className="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm">
            <div>
              <p className="font-bold text-slate-800">{r.title}</p>
              <p className="text-xs text-slate-400">{r.date}</p>
            </div>
            <button 
              onClick={() => setReminders(reminders.filter(rem => rem.id !== r.id))}
              className="text-slate-300 hover:text-red-500"
            >
              <X size={16} />
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}
