<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Shared Memories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Inter:wght@400;600;700&family=Caveat:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,700&family=Indie+Flower&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            transition: background 0.5s ease;
        }
        
        .font-dancing { font-family: 'Dancing Script', cursive; }
        .font-caveat { font-family: 'Caveat', cursive; }
        .font-indie { font-family: 'Indie Flower', cursive; }
        .font-playfair { font-family: 'Playfair Display', serif; }

        .bg-cork { 
            background-color: #d6d3d1; 
            background-image: radial-gradient(#b0adab 1px, transparent 1px); 
            background-size: 20px 20px; 
        }
        .bg-wood {
            background-color: #451a03;
            background-image: repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(0,0,0,0.05) 40px, rgba(0,0,0,0.05) 80px);
        }
        .bg-fabric {
            background-color: #fdf2f8;
            background-image:  linear-gradient(30deg, #fce7f3 12%, transparent 12.5%, transparent 87%, #fce7f3 87.5%, #fce7f3), linear-gradient(150deg, #fce7f3 12%, transparent 12.5%, transparent 87%, #fce7f3 87.5%, #fce7f3), linear-gradient(30deg, #fce7f3 12%, transparent 12.5%, transparent 87%, #fce7f3 87.5%, #fce7f3), linear-gradient(150deg, #fce7f3 12%, transparent 12.5%, transparent 87%, #fce7f3 87.5%, #fce7f3), linear-gradient(60deg, #fbcfe8 25%, transparent 25.5%, transparent 75%, #fbcfe8 75%, #fbcfe8), linear-gradient(60deg, #fbcfe8 25%, transparent 25.5%, transparent 75%, #fbcfe8 75%, #fbcfe8);
            background-size: 40px 70px;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        
        .pin-dot { transition: all 0.2s ease; background-color: #e5e7eb; border: 1px solid #d1d5db; }
        .pin-dot.active { background-color: #ec4899; border-color: #db2777; transform: scale(1.2); }
        
        .keypad-btn { cursor: pointer; user-select: none; -webkit-user-select: none; touch-action: manipulation; transition: transform 0.1s; }
        .keypad-btn:active { background-color: #fce7f3 !important; transform: scale(0.9); }

        /* Photo Styles */
        .img-style-round { border-radius: 50%; aspect-ratio: 1/1; object-fit: cover; }
        .img-style-sharp { border-radius: 0px; }
        .img-style-oval { border-radius: 100px; aspect-ratio: 4/5; object-fit: cover; }
        .img-style-polar { border-radius: 4px; border: 10px solid white; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }

        /* Photo Filters */
        .filter-none { filter: none; }
        .filter-tokyo { filter: contrast(1.1) brightness(1.1) saturate(0.9) sepia(0.15) hue-rotate(-5deg); }
        .filter-midnight { filter: brightness(0.85) contrast(1.2) saturate(1.1) hue-rotate(190deg); }
        .filter-retro { filter: grayscale(0.1) sepia(0.3) contrast(0.95); }
    </style>
</head>
<body class="bg-pink-50 min-h-screen">
    <div id="app">
        <!-- Lock Screen -->
        <div id="lock-screen" class="flex flex-col items-center justify-center min-h-screen fixed inset-0 z-[100] bg-pink-50">
            <div id="lock-container" class="bg-white p-8 rounded-3xl shadow-2xl w-[90%] max-w-sm border border-pink-100 text-center relative z-[110]">
                <div class="mb-6">
                    <div class="w-16 h-16 bg-pink-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Our Secret Space</h2>
                    <p id="lock-instruction" class="text-gray-500 text-sm mt-1">Enter the pin to see our moments</p>
                </div>
                <div id="pin-display" class="flex justify-center gap-3 mb-8">
                    <div class="pin-dot w-4 h-4 rounded-full"></div>
                    <div class="pin-dot w-4 h-4 rounded-full"></div>
                    <div class="pin-dot w-4 h-4 rounded-full"></div>
                    <div class="pin-dot w-4 h-4 rounded-full"></div>
                    <div class="pin-dot w-4 h-4 rounded-full"></div>
                    <div class="pin-dot w-4 h-4 rounded-full"></div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <button type="button" onclick="addDigit('1')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">1</button>
                    <button type="button" onclick="addDigit('2')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">2</button>
                    <button type="button" onclick="addDigit('3')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">3</button>
                    <button type="button" onclick="addDigit('4')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">4</button>
                    <button type="button" onclick="addDigit('5')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">5</button>
                    <button type="button" onclick="addDigit('6')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">6</button>
                    <button type="button" onclick="addDigit('7')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">7</button>
                    <button type="button" onclick="addDigit('8')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">8</button>
                    <button type="button" onclick="addDigit('9')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">9</button>
                    <button type="button" onclick="backspace()" class="keypad-btn h-14 rounded-2xl bg-gray-100 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg></button>
                    <button type="button" onclick="addDigit('0')" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xl font-bold">0</button>
                    <button type="button" onclick="clearPin()" class="keypad-btn h-14 rounded-2xl bg-gray-100 text-xs font-bold text-gray-400">CLR</button>
                </div>
            </div>
        </div>

        <!-- Main Board -->
        <div id="main-board" class="hidden min-h-screen bg-cork pb-24 transition-all duration-500">
            <nav class="bg-white/95 backdrop-blur shadow-sm p-4 sticky top-0 z-40 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üíù</span>
                    <div>
                        <h1 class="font-bold text-gray-800 leading-none">Our Shared Memories</h1>
                        <div class="flex gap-2 mt-1">
                            <button onclick="changeBoardTheme('bg-cork')" class="w-3 h-3 rounded-full bg-stone-400 border border-stone-500"></button>
                            <button onclick="changeBoardTheme('bg-wood')" class="w-3 h-3 rounded-full bg-amber-900 border border-amber-950"></button>
                            <button onclick="changeBoardTheme('bg-fabric')" class="w-3 h-3 rounded-full bg-pink-200 border border-pink-300"></button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="generateDateIdea()" class="text-[10px] bg-pink-100 text-pink-600 px-3 py-1.5 rounded-full font-bold border border-pink-200">‚ú® AI Date</button>
                </div>
            </nav>

            <div id="board-grid" class="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>

            <button onclick="openModal()" class="fixed bottom-6 right-6 bg-pink-500 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center z-50 transform active:scale-90 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>

        <!-- Add/Edit Modal -->
        <div id="modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm overflow-y-auto">
            <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl my-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800">New Memory</h3>
                    <button onclick="closeModal()" class="text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
                
                <div id="type-selector" class="flex gap-2 mb-4 bg-gray-100 p-1 rounded-xl">
                    <button id="type-note" onclick="setType('note')" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow-sm transition-all">Note</button>
                    <button id="type-photo" onclick="setType('photo')" class="flex-1 py-2 rounded-lg font-bold text-sm transition-all">Photo</button>
                </div>

                <div id="style-controls" class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Font Style</label>
                        <select id="style-font" class="w-full text-xs p-2 bg-gray-50 border rounded-lg outline-none">
                            <option value="font-dancing">Handwriting (Dancing)</option>
                            <option value="font-caveat">Sketchy (Caveat)</option>
                            <option value="font-indie">Casual (Indie)</option>
                            <option value="font-playfair">Elegant (Serif)</option>
                            <option value="font-inter">Modern (Sans)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Text Size</label>
                        <select id="style-size" class="w-full text-xs p-2 bg-gray-50 border rounded-lg outline-none">
                            <option value="text-lg">Small</option>
                            <option value="text-2xl" selected>Normal</option>
                            <option value="text-4xl">Large</option>
                        </select>
                    </div>
                </div>

                <!-- Note Specific -->
                <div id="note-input">
                    <div class="mb-3">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Sticky Color</label>
                        <div class="flex gap-2 mt-1">
                            <button onclick="setStickyColor('bg-yellow-100')" class="w-6 h-6 rounded-md bg-yellow-100 border border-yellow-200"></button>
                            <button onclick="setStickyColor('bg-pink-100')" class="w-6 h-6 rounded-md bg-pink-100 border border-pink-200"></button>
                            <button onclick="setStickyColor('bg-blue-100')" class="w-6 h-6 rounded-md bg-blue-100 border border-blue-200"></button>
                            <button onclick="setStickyColor('bg-green-100')" class="w-6 h-6 rounded-md bg-green-100 border border-green-200"></button>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="content-text" class="w-full h-32 p-3 bg-yellow-100 border border-black/5 rounded-xl outline-none font-dancing text-2xl" placeholder="Write something sweet..."></textarea>
                        <button onclick="enhanceNote()" id="enhance-btn" class="absolute bottom-2 right-2 text-[10px] bg-white/80 border border-pink-200 text-pink-500 font-bold py-1 px-2 rounded-lg">‚ú® AI Sweeten</button>
                    </div>
                </div>

                <!-- Photo Specific -->
                <div id="photo-input" class="hidden space-y-4">
                    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFile(event)">
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Photo Shape</label>
                            <select id="style-img-shape" onchange="updatePhotoPreview()" class="w-full text-xs p-2 bg-gray-50 border rounded-lg outline-none">
                                <option value="img-style-sharp">Sharp (Square)</option>
                                <option value="img-style-round">Round (Circle)</option>
                                <option value="img-style-oval">Oval (Artistic)</option>
                                <option value="img-style-polar">Polar (Frame)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Aesthetic Filter</label>
                            <select id="style-img-filter" onchange="updatePhotoPreview()" class="w-full text-xs p-2 bg-gray-50 border rounded-lg outline-none">
                                <option value="filter-none">Natural</option>
                                <option value="filter-tokyo">Tokyo Summer ‚òÄÔ∏è</option>
                                <option value="filter-midnight">Midnight City üåÉ</option>
                                <option value="filter-retro">Retro Love üéûÔ∏è</option>
                            </select>
                        </div>
                    </div>

                    <div id="photo-preview-container" onclick="document.getElementById('file-input').click()" class="relative w-full aspect-square border-2 border-dashed border-pink-200 rounded-xl flex items-center justify-center bg-pink-50 overflow-hidden cursor-pointer">
                        <div id="img-preview-box" class="w-full h-full flex items-center justify-center p-4">
                            <img id="img-preview" class="hidden w-full h-full object-cover shadow-lg transition-all duration-300">
                        </div>
                        <span id="img-placeholder" class="text-pink-400 font-bold text-sm absolute">Tap to Select Photo</span>
                    </div>

                    <div class="relative">
                        <input id="content-caption" type="text" class="w-full p-3 pr-24 bg-gray-50 border rounded-xl outline-none font-dancing text-xl" placeholder="Add a caption...">
                        <button onclick="generateAICaption()" id="ai-caption-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] bg-pink-100 border border-pink-200 text-pink-600 font-bold py-1 px-2 rounded-lg">‚ú® AI Caption</button>
                    </div>
                </div>

                <div class="flex gap-2 mt-6">
                    <button onclick="closeModal()" class="flex-1 py-3 font-bold text-gray-500">Cancel</button>
                    <button onclick="saveMemory()" class="flex-[2] py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg">Pin It!</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const apiKey = ""; 
        const SECRET_PIN = "162930";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'love-board-v2';
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let memories = [];
        let currentType = 'note';
        let base64Image = null;
        let currentPinValue = "";
        let editingId = null;
        let selectedStickyColor = 'bg-yellow-100';

        // GLOBAL PIN LOGIC (Assigned to window for HTML onclick access)
        window.addDigit = (d) => {
            if (currentPinValue.length < 6) {
                currentPinValue += d;
                updatePinUI();
                if (currentPinValue.length === 6) {
                    setTimeout(verifyPin, 150);
                }
            }
        };

        window.backspace = () => {
            currentPinValue = currentPinValue.slice(0, -1);
            updatePinUI();
        };

        window.clearPin = () => {
            currentPinValue = "";
            updatePinUI();
        };

        function updatePinUI() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, i) => {
                if (i < currentPinValue.length) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        function verifyPin() {
            if (currentPinValue === SECRET_PIN) {
                const instr = document.getElementById('lock-instruction');
                instr.innerText = "Access Granted! üíñ";
                instr.className = "text-pink-600 font-bold text-sm mt-1 animate-pulse";
                
                setTimeout(() => {
                    document.getElementById('lock-screen').style.display = 'none';
                    document.getElementById('main-board').classList.remove('hidden');
                }, 600);
            } else {
                const container = document.getElementById('lock-container');
                container.classList.add('animate-shake');
                setTimeout(() => {
                    container.classList.remove('animate-shake');
                    currentPinValue = "";
                    updatePinUI();
                }, 400);
            }
        }

        // Theme and Modal Logic
        window.changeBoardTheme = (t) => {
            document.getElementById('main-board').className = `min-h-screen ${t} pb-24 transition-all duration-500`;
        };

        window.openModal = () => {
            resetForm();
            document.getElementById('modal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
            editingId = null;
            base64Image = null;
        };

        function resetForm() {
            document.getElementById('content-text').value = "";
            document.getElementById('content-caption').value = "";
            document.getElementById('img-preview').classList.add('hidden');
            document.getElementById('img-placeholder').classList.remove('hidden');
            document.getElementById('modal-title').innerText = "New Memory";
            editingId = null;
        }

        window.setType = (type) => {
            currentType = type;
            document.getElementById('type-note').className = `flex-1 py-2 rounded-lg font-bold text-sm transition-all ${type === 'note' ? 'bg-white shadow-sm' : ''}`;
            document.getElementById('type-photo').className = `flex-1 py-2 rounded-lg font-bold text-sm transition-all ${type === 'photo' ? 'bg-white shadow-sm' : ''}`;
            document.getElementById('note-input').classList.toggle('hidden', type !== 'note');
            document.getElementById('photo-input').classList.toggle('hidden', type !== 'photo');
        };

        window.setStickyColor = (c) => { 
            selectedStickyColor = c; 
            document.getElementById('content-text').className = `w-full h-32 p-3 ${c} border border-black/5 rounded-xl outline-none font-dancing text-2xl`; 
        };

        window.handleFile = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                base64Image = ev.target.result;
                const img = document.getElementById('img-preview');
                img.src = base64Image;
                img.classList.remove('hidden');
                document.getElementById('img-placeholder').classList.add('hidden');
                updatePhotoPreview();
            };
            reader.readAsDataURL(file);
        };

        window.updatePhotoPreview = () => {
            const img = document.getElementById('img-preview');
            const shape = document.getElementById('style-img-shape').value;
            const filter = document.getElementById('style-img-filter').value;
            img.className = `w-full h-full object-cover transition-all duration-300 ${shape} ${filter}`;
        };

        // Firestore Logic
        window.saveMemory = async () => {
            if (!currentUser) return;
            const data = {
                type: currentType,
                font: document.getElementById('style-font').value,
                fontSize: document.getElementById('style-size').value,
                timestamp: new Date().toLocaleDateString(),
                userId: currentUser.uid
            };

            if (currentType === 'note') {
                data.content = document.getElementById('content-text').value;
                data.color = selectedStickyColor;
                if (!data.content) return;
            } else {
                data.image = base64Image;
                data.caption = document.getElementById('content-caption').value;
                data.shape = document.getElementById('style-img-shape').value;
                data.filter = document.getElementById('style-img-filter').value;
                if (!data.image) return;
            }

            const memoriesCol = collection(db, 'artifacts', appId, 'public', 'data', 'memories');
            try {
                if (editingId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memories', editingId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memories', Date.now().toString()), data);
                }
                closeModal();
            } catch (err) {
                console.error("Save error", err);
            }
        };

        window.editMemory = (id) => {
            const m = memories.find(item => item.id === id);
            if (!m) return;
            editingId = id;
            document.getElementById('modal-title').innerText = "Edit Memory";
            setType(m.type);
            document.getElementById('style-font').value = m.font || 'font-dancing';
            document.getElementById('style-size').value = m.fontSize || 'text-2xl';
            if (m.type === 'note') {
                document.getElementById('content-text').value = m.content;
                window.setStickyColor(m.color || 'bg-yellow-100');
            } else {
                base64Image = m.image;
                document.getElementById('img-preview').src = base64Image;
                document.getElementById('img-preview').classList.remove('hidden');
                document.getElementById('img-placeholder').classList.add('hidden');
                document.getElementById('content-caption').value = m.caption || "";
                document.getElementById('style-img-shape').value = m.shape || "img-style-sharp";
                document.getElementById('style-img-filter').value = m.filter || "filter-none";
                updatePhotoPreview();
            }
            document.getElementById('modal').classList.remove('hidden');
        };

        window.deleteMemory = async (id) => { 
            if (confirm("Delete this memory forever?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memories', id)); 
            }
        };

        // Render Logic
        function renderBoard() {
            const grid = document.getElementById('board-grid');
            if (!grid) return;
            grid.innerHTML = memories.map(m => {
                const bg = m.type === 'note' ? (m.color || 'bg-yellow-100') : 'bg-white';
                const font = m.font || 'font-dancing';
                const size = m.fontSize || 'text-2xl';
                const controls = `
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 z-10">
                        <button onclick="editMemory('${m.id}')" class="bg-white/90 p-1.5 rounded-lg shadow-sm text-blue-500 hover:scale-110"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        <button onclick="deleteMemory('${m.id}')" class="bg-white/90 p-1.5 rounded-lg shadow-sm text-red-500 hover:scale-110"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </div>
                `;

                if (m.type === 'note') {
                    return `<div class="relative ${bg} p-6 shadow-xl transform rotate-1 hover:rotate-0 transition-all group min-h-[160px] border-b-4 border-black/5">
                        ${controls}
                        <p class="${font} ${size} text-gray-800 break-words">${m.content}</p>
                        <p class="absolute bottom-2 right-2 text-[8px] text-black/20 font-bold uppercase">${m.timestamp}</p>
                    </div>`;
                } else {
                    return `<div class="relative bg-white p-3 pb-8 shadow-xl transform -rotate-1 hover:rotate-0 transition-all group border border-gray-100 flex flex-col items-center">
                        ${controls}
                        <div class="w-full aspect-square bg-gray-50 flex items-center justify-center p-1 overflow-hidden">
                            <img src="${m.image}" class="w-full h-full object-cover ${m.shape || 'img-style-sharp'} ${m.filter || 'filter-none'}">
                        </div>
                        <p class="${font} text-center ${size} text-gray-700 mt-2">${m.caption || ''}</p>
                        <p class="absolute bottom-1 right-2 text-[8px] text-gray-300 font-bold">${m.timestamp}</p>
                    </div>`;
                }
            }).join('');
        }

        // Initialize App
        async function init() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'memories'), (snapshot) => {
                            memories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                            renderBoard();
                        }, (err) => console.error("Snapshot error", err));
                    }
                });
            } catch (err) {
                console.error("Init error", err);
            }
        }
        
        init();
    </script>
</body>
</html>