<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Beloving World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .handwriting { font-family: 'Dancing Script', cursive; }
        @keyframes marquee { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
        .animate-marquee { animation: marquee 10s linear infinite; }
        .modal-bg { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="transition-colors duration-500 bg-white">

    <div id="app">
        <!-- Auth View -->
        <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center bg-white transition-opacity duration-500">
            <h1 class="text-4xl md:text-5xl font-bold mb-8 text-gray-800 text-center px-4">To our beloving World</h1>
            <div class="relative flex items-center">
                <i data-lucide="lock" class="absolute -left-12 text-gray-300" size="32"></i>
                <input type="password" id="passcode-input" maxlength="6" placeholder="••••••" class="text-4xl tracking-widest text-center w-64 p-4 border-b-4 border-gray-200 focus:border-rose-400 outline-none transition-all"/>
            </div>
            <div class="mt-8 h-10 text-center">
                <p id="auth-message" class="text-sm text-gray-400 italic">Enter your secret code to enter</p>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-screen" class="hidden min-h-screen">
            <header class="sticky top-0 z-30 w-full h-20 flex items-center justify-between px-4 md:px-8 border-b glass">
                <div class="flex gap-2">
                    <button onclick="setTheme('romantic')" class="w-6 h-6 rounded-full bg-rose-400 border-2 border-white shadow-sm"></button>
                    <button onclick="setTheme('midnight')" class="w-6 h-6 rounded-full bg-indigo-900 border-2 border-white shadow-sm"></button>
                </div>
                <h1 class="text-xl font-bold tracking-widest uppercase text-center">You are my World</h1>
                <div class="flex items-center gap-4">
                    <p id="header-event" class="hidden md:block text-xs font-bold italic opacity-70">No events</p>
                    <button onclick="openModal('settings')" class="p-2 hover:bg-black/5 rounded-full"><i data-lucide="calendar" size="20"></i></button>
                </div>
            </header>

            <main class="max-w-7xl mx-auto p-4 md:p-8 pb-32">
                <div id="pins-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                
                <div class="fixed bottom-10 left-1/2 -translate-x-1/2 z-40 group">
                    <button class="w-16 h-16 bg-rose-500 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-transform">
                        <i data-lucide="heart" fill="currentColor" size="28"></i>
                    </button>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-4 flex gap-4 opacity-0 scale-0 group-hover:opacity-100 group-hover:scale-100 transition-all pointer-events-none group-hover:pointer-events-auto">
                        <button onclick="openModal('note')" class="bg-white px-4 py-2 rounded-full shadow-xl border flex items-center gap-2 whitespace-nowrap"><i data-lucide="type" size="16"></i> Note</button>
                        <button onclick="openModal('photo')" class="bg-white px-4 py-2 rounded-full shadow-xl border flex items-center gap-2 whitespace-nowrap"><i data-lucide="image" size="16"></i> Photo</button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal Container -->
        <div id="modal-container" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // CONFIG - Safely handle environment variables
        const safeParse = (str) => { try { return JSON.parse(str); } catch(e) { return null; } };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? safeParse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'local-app';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const CORRECT_CODE = "162930";
        const apiKey = ""; 

        let db, auth, isLocal = !firebaseConfig;
        let user = null;
        let pins = [];
        let dates = [];

        // UI Selectors
        const authScreen = document.getElementById('auth-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const passcodeIn = document.getElementById('passcode-input');
        const authMsg = document.getElementById('auth-message');
        const pinsGrid = document.getElementById('pins-grid');
        const modalCont = document.getElementById('modal-container');

        lucide.createIcons();

        // 1. Initialize Firebase if config exists
        if (!isLocal) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.warn("Firebase initialization failed, switching to local mode.");
                isLocal = true;
            }
        }

        // 2. Auth Flow
        passcodeIn.addEventListener('input', async (e) => {
            if (e.target.value === CORRECT_CODE) {
                authMsg.innerText = "Access Granted... ✨";
                authMsg.className = "text-rose-500 font-bold animate-pulse";
                
                if (isLocal) {
                    user = { uid: 'local-user' };
                    transitionToDashboard();
                } else {
                    try {
                        if (initialToken) await signInWithCustomToken(auth, initialToken);
                        else await signInAnonymously(auth);
                    } catch (err) {
                        console.warn("Cloud auth failed, falling back to local mode");
                        isLocal = true;
                        user = { uid: 'local-user' };
                        transitionToDashboard();
                    }
                }
            }
        });

        if (!isLocal && auth) {
            onAuthStateChanged(auth, (u) => {
                if (u) {
                    user = u;
                    transitionToDashboard();
                }
            });
        }

        function transitionToDashboard() {
            authScreen.classList.add('opacity-0');
            setTimeout(() => {
                authScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                startSync();
            }, 500);
        }

        // 3. Data Sync Logic
        function startSync() {
            if (isLocal) {
                pins = JSON.parse(localStorage.getItem('pins') || '[]');
                dates = JSON.parse(localStorage.getItem('dates') || '[]');
                renderPins();
                renderDates();
            } else {
                const pinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'pins');
                onSnapshot(pinsRef, (snap) => {
                    pins = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderPins();
                }, (err) => {
                    console.error("Firestore error, falling back to local storage.");
                    isLocal = true;
                    startSync();
                });

                const datesRef = collection(db, 'artifacts', appId, 'public', 'data', 'dates');
                onSnapshot(datesRef, (snap) => {
                    dates = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderDates();
                });
            }
        }

        function renderPins() {
            const sorted = [...pins].sort((a,b) => {
                const timeA = a.createdAt?.seconds || a.localTime || 0;
                const timeB = b.createdAt?.seconds || b.localTime || 0;
                return timeB - timeA;
            });
            
            pinsGrid.innerHTML = sorted.map(pin => {
                const isNote = pin.type === 'note';
                return `
                    <div class="group bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative hover:shadow-md transition-all">
                        <button onclick="deletePin('${pin.id}')" class="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 shadow-lg z-10">
                            <i data-lucide="x" size="12"></i>
                        </button>
                        ${isNote ? 
                            `<p class="whitespace-pre-wrap text-gray-700 leading-relaxed">${pin.content}</p>` :
                            `<div class="aspect-square bg-gray-50 rounded-xl mb-3 flex items-center justify-center overflow-hidden border">
                                <i data-lucide="image" class="text-gray-300" size="48"></i>
                             </div>
                             <p class="text-center italic text-sm text-gray-500">${pin.caption || 'A special moment'}</p>`
                        }
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderDates() {
            const sorted = [...dates].sort((a,b) => new Date(a.date) - new Date(b.date));
            const header = document.getElementById('header-event');
            if (sorted[0]) header.innerText = `Upcoming: ${sorted[0].title}`;
            lucide.createIcons();
        }

        // Global Action Functions
        window.deletePin = async (id) => {
            if (isLocal) {
                pins = pins.filter(p => p.id !== id);
                localStorage.setItem('pins', JSON.stringify(pins));
                renderPins();
            } else {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pins', id));
            }
        };

        window.openModal = (type) => {
            modalCont.classList.remove('hidden');
            if (type === 'note') {
                modalCont.innerHTML = `
                    <div class="bg-white rounded-3xl w-full max-w-lg p-6 shadow-2xl">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold text-lg">New Note</h3>
                            <button onclick="closeModal()"><i data-lucide="x"></i></button>
                        </div>
                        <textarea id="note-text" class="w-full h-40 p-4 bg-gray-50 border rounded-2xl outline-none focus:ring-2 focus:ring-rose-200" placeholder="Type something sweet..."></textarea>
                        <button onclick="saveNote()" class="w-full mt-4 py-3 bg-rose-500 text-white rounded-xl font-bold">Save Note</button>
                    </div>
                `;
            } else if (type === 'settings') {
                modalCont.innerHTML = `
                    <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold text-lg">Dates & Events</h3>
                            <button onclick="closeModal()"><i data-lucide="x"></i></button>
                        </div>
                        <div class="space-y-4">
                            <input id="date-title" placeholder="Event name" class="w-full p-3 bg-gray-50 border rounded-xl outline-none" />
                            <input id="date-val" type="date" class="w-full p-3 bg-gray-50 border rounded-xl outline-none" />
                            <button onclick="saveDate()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Add Event</button>
                        </div>
                    </div>
                `;
            } else if (type === 'photo') {
                modalCont.innerHTML = `
                    <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold text-lg">Pin Photo</h3>
                            <button onclick="closeModal()"><i data-lucide="x"></i></button>
                        </div>
                        <input id="photo-caption" placeholder="Caption for this photo..." class="w-full p-3 bg-gray-50 border rounded-xl outline-none" />
                        <button onclick="savePhoto()" class="w-full mt-4 py-3 bg-blue-500 text-white rounded-xl font-bold">Pin Now</button>
                    </div>
                `;
            }
            lucide.createIcons();
        };

        window.closeModal = () => modalCont.classList.add('hidden');

        window.saveNote = async () => {
            const content = document.getElementById('note-text').value;
            if (!content.trim()) return;
            const data = { 
                id: Date.now().toString(), 
                type: 'note', 
                content, 
                localTime: Math.floor(Date.now()/1000) 
            };
            if (isLocal) {
                pins.push(data);
                localStorage.setItem('pins', JSON.stringify(pins));
                renderPins();
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pins'), { ...data, createdAt: serverTimestamp() });
            }
            closeModal();
        };

        window.savePhoto = async () => {
            const caption = document.getElementById('photo-caption').value;
            const data = { 
                id: Date.now().toString(), 
                type: 'photo', 
                caption, 
                localTime: Math.floor(Date.now()/1000) 
            };
            if (isLocal) {
                pins.push(data);
                localStorage.setItem('pins', JSON.stringify(pins));
                renderPins();
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pins'), { ...data, createdAt: serverTimestamp() });
            }
            closeModal();
        };

        window.saveDate = async () => {
            const title = document.getElementById('date-title').value;
            const date = document.getElementById('date-val').value;
            if (!title || !date) return;
            const data = { id: Date.now().toString(), title, date };
            if (isLocal) {
                dates.push(data);
                localStorage.setItem('dates', JSON.stringify(dates));
                renderDates();
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'dates'), { ...data, createdAt: serverTimestamp() });
            }
            closeModal();
        };

        window.setTheme = (t) => {
            const themes = {
                romantic: "bg-rose-50 text-rose-900",
                midnight: "bg-slate-900 text-indigo-100"
            };
            document.body.className = `transition-colors duration-500 ${themes[t] || 'bg-white'}`;
        };
    </script>
</body>
</html>