import React, { useState, useEffect, useRef } from 'react';
import { 
  Heart, 
  Settings, 
  Plus, 
  Calendar, 
  Type, 
  Image as ImageIcon, 
  X, 
  Sparkles, 
  Palette, 
  Clock,
  Trash2,
  Lock
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  doc, 
  onSnapshot, 
  addDoc, 
  deleteDoc, 
  query, 
  orderBy,
  setDoc,
  serverTimestamp 
} from 'firebase/firestore';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Components ---

const Fireworks = () => {
  return (
    <div className="fixed inset-0 pointer-events-none z-50">
      {[...Array(12)].map((_, i) => (
        <div 
          key={i} 
          className="absolute animate-ping rounded-full bg-yellow-400"
          style={{
            width: '10px',
            height: '10px',
            top: `${Math.random() * 100}%`,
            left: `${Math.random() * 100}%`,
            animationDuration: `${0.5 + Math.random()}s`,
          }}
        />
      ))}
    </div>
  );
};

const FallingFrowns = () => {
  return (
    <div className="fixed inset-0 pointer-events-none z-50 overflow-hidden">
      {[...Array(20)].map((_, i) => (
        <div 
          key={i} 
          className="absolute text-4xl animate-bounce"
          style={{
            top: '-50px',
            left: `${Math.random() * 100}%`,
            animationDelay: `${Math.random() * 2}s`,
            animationDuration: '3s',
            transform: `translateY(110vh)`
          }}
        >
          ☹️
        </div>
      ))}
    </div>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  const [isLocked, setIsLocked] = useState(true);
  const [passcode, setPasscode] = useState('');
  const [error, setError] = useState(false);
  const [success, setSuccess] = useState(false);
  const [theme, setTheme] = useState('romantic'); // romantic, midnight, sunset
  const [pins, setPins] = useState([]);
  const [dates, setDates] = useState([]);
  const [showModal, setShowModal] = useState(null); 
  const [isAiLoading, setIsAiLoading] = useState(false);

  // Constants
  const CORRECT_CODE = "162930";
  const apiKey = ""; // Gemini API Key

  // Theme Styles
  const themes = {
    romantic: "bg-rose-50 text-rose-900 border-rose-200 accent-rose-500",
    midnight: "bg-slate-900 text-indigo-100 border-indigo-900 accent-indigo-400",
    sunset: "bg-orange-50 text-orange-900 border-orange-200 accent-orange-500"
  };

  // Auth Effect
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Sync Pins and Dates from Firestore
  useEffect(() => {
    if (!user) return;

    // Listen to Pins
    const pinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'pins');
    const unsubscribePins = onSnapshot(pinsRef, (snapshot) => {
      const pinsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Simple sort in memory (Rule 2)
      setPins(pinsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
    }, (err) => console.error("Pins Sync Error", err));

    // Listen to Dates
    const datesRef = collection(db, 'artifacts', appId, 'public', 'data', 'dates');
    const unsubscribeDates = onSnapshot(datesRef, (snapshot) => {
      const datesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setDates(datesData.sort((a, b) => new Date(a.date) - new Date(b.date)));
    }, (err) => console.error("Dates Sync Error", err));

    return () => {
      unsubscribePins();
      unsubscribeDates();
    };
  }, [user]);

  const checkPasscode = (val) => {
    if (val.length === 6) {
      if (val === CORRECT_CODE) {
        setSuccess(true);
        setError(false);
        setTimeout(() => setIsLocked(false), 2000);
      } else {
        setError(true);
        setSuccess(false);
        setPasscode('');
        setTimeout(() => setError(false), 3000);
      }
    }
  };

  const handleAiLetter = async (currentNote, setNoteContent) => {
    setIsAiLoading(true);
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Write a short, romantic, deeply moving love letter for a long distance relationship. Focus on longing, memories, and the future. Context: ${currentNote || 'Thinking of you.'}` }] }]
        })
      });
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      setNoteContent(text);
    } catch (err) {
      console.error("AI Error", err);
    } finally {
      setIsAiLoading(false);
    }
  };

  const addPin = async (item) => {
    if (!user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pins'), {
        ...item,
        createdAt: serverTimestamp(),
        authorId: user.uid
      });
      setShowModal(null);
    } catch (err) {
      console.error("Error adding pin", err);
    }
  };

  const deletePin = async (id) => {
    if (!user) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pins', id));
    } catch (err) {
      console.error("Error deleting pin", err);
    }
  };

  const addDate = async (title, date) => {
    if (!user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'dates'), {
        title,
        date,
        createdAt: serverTimestamp()
      });
    } catch (err) {
      console.error("Error adding date", err);
    }
  };

  const deleteDate = async (id) => {
    if (!user) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dates', id));
    } catch (err) {
      console.error("Error deleting date", err);
    }
  };

  // --- Auth View ---
  if (isLocked) {
    return (
      <div className={`min-h-screen flex flex-col items-center justify-center transition-colors duration-1000 ${error ? 'bg-red-50' : 'bg-white'}`}>
        {success && <Fireworks />}
        {error && <FallingFrowns />}
        
        <h1 className="text-5xl font-bold mb-8 text-gray-800 animate-pulse">To our beloving World</h1>
        
        <div className="relative group">
          <input 
            type="password" 
            maxLength={6}
            value={passcode}
            onChange={(e) => {
              const val = e.target.value;
              setPasscode(val);
              checkPasscode(val);
            }}
            placeholder="••••••"
            className="text-4xl tracking-widest text-center w-64 p-4 border-b-4 border-gray-300 focus:border-rose-400 outline-none bg-transparent transition-all"
          />
          <Lock className="absolute -left-12 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-rose-400" size={32} />
        </div>

        <div className="mt-12 h-10 overflow-hidden text-center">
          {success && (
            <p className="text-2xl text-rose-500 font-medium animate-bounce">
              Welcome to our world! ✨
            </p>
          )}
          {error && (
            <p className="text-lg text-red-500 font-medium italic">
              Sorry you are not the one who can enter
            </p>
          )}
          {!success && !error && (
            <p className="text-sm text-gray-400">Hint: Your ID {user?.uid}</p>
          )}
        </div>
      </div>
    );
  }

  // --- Dashboard View ---
  return (
    <div className={`min-h-screen transition-all duration-500 ${themes[theme]}`}>
      {/* Running Light Header */}
      <header className="relative w-full h-20 flex items-center justify-between px-8 border-b shadow-sm overflow-hidden">
        <div className="absolute inset-0 pointer-events-none">
          <div className="h-1 w-full animate-[marquee_5s_linear_infinite] bg-gradient-to-r from-transparent via-white to-transparent opacity-50"></div>
        </div>

        {/* Theme Options */}
        <div className="flex gap-4 items-center z-10">
          <Palette size={20} className="opacity-70" />
          <div className="flex gap-2">
            {Object.keys(themes).map(t => (
              <button 
                key={t}
                onClick={() => setTheme(t)}
                className={`w-6 h-6 rounded-full border-2 ${theme === t ? 'border-current scale-125' : 'border-transparent opacity-50'}`}
                style={{ backgroundColor: t === 'romantic' ? '#fb7185' : t === 'midnight' ? '#312e81' : '#f97316' }}
              />
            ))}
          </div>
        </div>

        <h1 className="text-2xl font-bold tracking-[0.2em] uppercase flex items-center gap-2">
          <div className="w-2 h-2 rounded-full bg-rose-500 animate-ping" />
          You are my World
          <div className="w-2 h-2 rounded-full bg-rose-500 animate-ping" />
        </h1>

        {/* Date Reminder & Settings */}
        <div className="flex items-center gap-6 z-10">
          <div className="text-right hidden sm:block">
            <p className="text-xs uppercase opacity-70">Next Event</p>
            <p className="font-bold flex items-center gap-1 justify-end">
              <Clock size={14} /> {dates[0]?.title || 'No events'}
            </p>
          </div>
          <button 
            onClick={() => setShowModal('settings')}
            className="p-2 hover:bg-black/5 rounded-full transition-colors"
          >
            <Settings size={24} />
          </button>
        </div>
      </header>

      {/* Main Board */}
      <main className="max-w-7xl mx-auto p-8 relative">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 min-h-[60vh]">
          {pins.map((pin) => (
            <div 
              key={pin.id} 
              className={`group p-6 rounded-lg shadow-lg relative transition-transform hover:-rotate-1 hover:scale-105 ${
                pin.type === 'note' ? (pin.template === 'torn' ? 'bg-[#fff9c4] border-l-4 border-dashed border-gray-400' : 'bg-white') : ''
              }`}
              style={{ 
                border: pin.type === 'photo' ? `${pin.frameWidth || 8}px solid ${pin.frameColor || '#fff'}` : '',
                borderRadius: pin.frameType === 'round' ? '999px' : '8px',
                aspectRatio: pin.frameType === 'round' ? '1/1' : 'auto'
              }}
            >
              <button 
                onClick={() => deletePin(pin.id)}
                className="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-20"
              >
                <X size={12} />
              </button>
              
              {pin.type === 'note' ? (
                <div className="space-y-2">
                  <p 
                    className={`whitespace-pre-wrap leading-relaxed text-gray-800`}
                    style={{ 
                      fontSize: pin.fontSize, 
                      fontWeight: pin.bold ? 'bold' : 'normal',
                      textDecoration: pin.underline ? 'underline' : 'none',
                      fontFamily: pin.fontStyle === 'handwriting' ? 'cursive' : 'sans-serif'
                    }}
                  >
                    {pin.content}
                  </p>
                </div>
              ) : (
                <div className="h-full flex flex-col justify-center items-center">
                  <div className={`w-full h-48 bg-gray-200 rounded flex items-center justify-center overflow-hidden mb-2 relative group`}>
                    <ImageIcon size={40} className="text-gray-400" />
                    <div className="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                      <p className="text-white text-xs px-2 py-1 bg-black/40 rounded uppercase tracking-tighter">{pin.pictureTheme}</p>
                    </div>
                  </div>
                  <p className="text-center italic text-sm text-gray-600">"{pin.caption}"</p>
                </div>
              )}
            </div>
          ))}
        </div>

        {/* Add Trigger */}
        <div className="flex justify-center mt-12 mb-20">
          <div className="relative group">
            <button className="w-16 h-16 bg-rose-500 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-transform active:scale-95">
              <Heart size={32} fill="currentColor" />
            </button>
            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-4 flex gap-4 scale-0 group-hover:scale-100 transition-transform origin-bottom">
              <button 
                onClick={() => setShowModal('note')}
                className="flex items-center gap-2 bg-white text-gray-800 px-4 py-2 rounded-full shadow-lg hover:bg-rose-50"
              >
                <Type size={18} /> Note
              </button>
              <button 
                onClick={() => setShowModal('photo')}
                className="flex items-center gap-2 bg-white text-gray-800 px-4 py-2 rounded-full shadow-lg hover:bg-rose-50"
              >
                <ImageIcon size={18} /> Photo
              </button>
            </div>
          </div>
        </div>
      </main>

      {/* --- Modals --- */}
      
      {showModal === 'note' && (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl w-full max-w-lg overflow-hidden flex flex-col shadow-2xl">
            <div className="p-4 border-b flex justify-between items-center bg-rose-50">
              <h3 className="font-bold flex items-center gap-2 text-gray-800"><Type size={18}/> Create a Love Note</h3>
              <button onClick={() => setShowModal(null)} className="text-gray-800"><X /></button>
            </div>
            <NoteEditor onSave={addPin} onAi={handleAiLetter} isAiLoading={isAiLoading} />
          </div>
        </div>
      )}

      {showModal === 'photo' && (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl">
            <div className="p-4 border-b flex justify-between items-center bg-blue-50">
              <h3 className="font-bold flex items-center gap-2 text-gray-800"><ImageIcon size={18}/> Pin a Moment</h3>
              <button onClick={() => setShowModal(null)} className="text-gray-800"><X /></button>
            </div>
            <PhotoEditor onSave={addPin} />
          </div>
        </div>
      )}

      {showModal === 'settings' && (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl text-gray-800">
            <div className="p-4 border-b flex justify-between items-center">
              <h3 className="font-bold flex items-center gap-2"><Calendar size={18}/> Dates & Memories</h3>
              <button onClick={() => setShowModal(null)}><X /></button>
            </div>
            <div className="p-6 space-y-4">
              <div className="max-h-60 overflow-y-auto space-y-2">
                {dates.map(d => (
                  <div key={d.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                      <p className="font-medium">{d.title}</p>
                      <p className="text-xs text-gray-500">{d.date}</p>
                    </div>
                    <button onClick={() => deleteDate(d.id)} className="text-red-400 hover:text-red-600">
                      <Trash2 size={16} />
                    </button>
                  </div>
                ))}
              </div>
              <form className="pt-4 border-t space-y-3" onSubmit={(e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                addDate(formData.get('title'), formData.get('date'));
                e.target.reset();
              }}>
                <input name="title" placeholder="Event name..." required className="w-full p-2 border rounded" />
                <input name="date" type="date" required className="w-full p-2 border rounded" />
                <button className="w-full py-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600">Add Reminder</button>
              </form>
            </div>
          </div>
        </div>
      )}

      <style>{`
        @keyframes marquee {
          from { transform: translateX(-100%); }
          to { transform: translateX(100%); }
        }
      `}</style>
    </div>
  );
}

// --- Editor Components ---

function NoteEditor({ onSave, onAi, isAiLoading }) {
  const [content, setContent] = useState('');
  const [fontStyle, setFontStyle] = useState('sans');
  const [fontSize, setFontSize] = useState('16px');
  const [isBold, setIsBold] = useState(false);
  const [isUnderline, setIsUnderline] = useState(false);
  const [template, setTemplate] = useState('standard');

  return (
    <div className="p-6 space-y-4 text-gray-800">
      <div className="flex flex-wrap gap-2 items-center bg-gray-50 p-2 rounded-lg text-xs">
        <select value={fontStyle} onChange={e => setFontStyle(e.target.value)} className="p-1 border rounded">
          <option value="sans">Modern</option>
          <option value="handwriting">Handwriting</option>
        </select>
        <select value={fontSize} onChange={e => setFontSize(e.target.value)} className="p-1 border rounded">
          <option value="14px">Small</option>
          <option value="18px">Medium</option>
          <option value="24px">Large</option>
        </select>
        <button onClick={() => setIsBold(!isBold)} className={`px-2 py-1 rounded border ${isBold ? 'bg-black text-white' : 'bg-white'}`}>B</button>
        <button onClick={() => setIsUnderline(!isUnderline)} className={`px-2 py-1 rounded border ${isUnderline ? 'bg-black text-white' : 'bg-white'}`}>U</button>
        <select value={template} onChange={e => setTemplate(e.target.value)} className="p-1 border rounded">
          <option value="standard">Standard</option>
          <option value="torn">Torn Paper</option>
        </select>
      </div>

      <textarea 
        className={`w-full h-48 p-4 border rounded-lg focus:ring-2 focus:ring-rose-200 outline-none transition-all ${template === 'torn' ? 'bg-[#fffde7]' : 'bg-white'}`}
        placeholder="Start writing your feelings..."
        value={content}
        onChange={e => setContent(e.target.value)}
        style={{ 
          fontFamily: fontStyle === 'handwriting' ? 'cursive' : 'sans-serif',
          fontSize, 
          fontWeight: isBold ? 'bold' : 'normal',
          textDecoration: isUnderline ? 'underline' : 'none'
        }}
      />

      <div className="flex gap-2">
        <button 
          onClick={() => onAi(content, setContent)}
          disabled={isAiLoading}
          className="flex-1 flex items-center justify-center gap-2 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 disabled:opacity-50"
        >
          <Sparkles size={16} /> {isAiLoading ? 'Writing...' : 'AI Love Letter'}
        </button>
        <button 
          onClick={() => onSave({ 
            type: 'note', content, fontStyle, fontSize, bold: isBold, underline: isUnderline, template 
          })}
          className="flex-1 py-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600"
        >
          Pin to Board
        </button>
      </div>
    </div>
  );
}

function PhotoEditor({ onSave }) {
  const [caption, setCaption] = useState('');
  const [frameType, setFrameType] = useState('square');
  const [frameColor, setFrameColor] = useState('#ffffff');
  const [frameWidth, setFrameWidth] = useState(12);
  const [pictureTheme, setPictureTheme] = useState('summer vibe');

  return (
    <div className="p-6 space-y-4 text-gray-800">
      <div className="grid grid-cols-2 gap-4">
        <div className="space-y-2">
          <label className="text-xs font-bold uppercase opacity-60">Frame Style</label>
          <div className="flex gap-2">
            <button onClick={() => setFrameType('square')} className={`flex-1 py-1 border rounded ${frameType === 'square' ? 'bg-gray-100' : ''}`}>Square</button>
            <button onClick={() => setFrameType('round')} className={`flex-1 py-1 border rounded ${frameType === 'round' ? 'bg-gray-100' : ''}`}>Round</button>
          </div>
        </div>
        <div className="space-y-2">
          <label className="text-xs font-bold uppercase opacity-60">Frame Color</label>
          <input type="color" value={frameColor} onChange={e => setFrameColor(e.target.value)} className="w-full h-8 cursor-pointer" />
        </div>
      </div>

      <div className="space-y-2">
        <label className="text-xs font-bold uppercase opacity-60">Picture Theme</label>
        <select value={pictureTheme} onChange={e => setPictureTheme(e.target.value)} className="w-full p-2 border rounded">
          <option value="tokyo sunset">Tokyo Sunset</option>
          <option value="summer vibe">Summer Vibe</option>
          <option value="retro polaroid">Retro Polaroid</option>
          <option value="neon nights">Neon Nights</option>
        </select>
      </div>

      <div className="space-y-2">
        <label className="text-xs font-bold uppercase opacity-60">Caption</label>
        <input 
          value={caption}
          onChange={e => setCaption(e.target.value)}
          placeholder="Describe this moment..."
          className="w-full p-2 border rounded"
        />
        <button 
          onClick={() => setCaption("A beautiful memory we'll cherish forever, frozen in time.")}
          className="text-xs text-indigo-500 flex items-center gap-1"
        >
          <Sparkles size={10} /> AI Suggestion
        </button>
      </div>

      <button 
        onClick={() => onSave({ 
          type: 'photo', caption, frameType, frameColor, frameWidth, pictureTheme 
        })}
        className="w-full py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
      >
        Pin Photo
      </button>
    </div>
  );
}
